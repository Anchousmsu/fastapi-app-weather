# fastapi-app-weather

    Сервис с перманентным опросом внешней системы реализован в ветке async_startup

Для запуска сервиса необходимо:
+ установить список пакетов из файла requirements.txt
+ положить файл .env в корень проекта и заполнить его на основе следующего примера:


	SERVER_PORT=8000
    DB_URL=postgresql+asyncpg://user:password@localhost/db

+ запуск сервиса производиться командой:

    > python src/app-weather/

+ в базе данных находятся 2 таблицы: day - в нее пишутся данные по текущей погоде, history - таблица, в которой содержатся исторические данные по средним температурам


+ в функции get_weather происходит чтение из таблицы day последней по времени и дате сохраненной записи. Если она была записана менее часа назад - возвращается в качестве ответа. Иначе происходит опрос внешней системы, запись в базу даных новой строки с обновленной температурой и возврат этой самой температуры. 
+ в функции get_history реализована следующая логика: происходит чтение всех записей таблицы day и находение средней температуры по каждому из дней. Затем из таблицы day удаляются все записи погоды, которые не являтся сегодяшними и не были записаны менее часа назад. На основе полученных данных первом шаге заполняется таблица history. Затем происходит целостное чтение из нее, что и является результатом работы функции
+ все рассмотренные функции работают асинхронно